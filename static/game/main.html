<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="three126.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="./styles.css" />
  </head>

  <body>
    <div id="nick"></div>
    <div id="root"></div>
    <div id="winScreen"></div>
    <div id="open" class="extend3" ><h4>Replay</h4></div>
    <div id="replay" class="extend2">
      <img src="mats/osiol.jpg" id="osioll" />
    </div>
    <div class="box extend1">
      <div class="box__content">
        <h2>REKORDY</h2>
        <div id="records"></div>
        <h2>gracze</h2>
        <div id="currentPlayers"></div>

        <!-- <button onclick="uploadScoore()" style="z-index: 20"></button> -->
      </div>
    </div>
    <div id="timeBlock"></div>
    <div id="login">
      <div id="left">
        <!-- <form action="/addPlayer" method="POST"> -->
        <label for="name">Wprowadź swoją nazwę:</label>
        <br />
        <input type="text" id="name" name="name" />
        <br />
        <input type="submit" value="dołącz" id="x" />
        <!-- </form> -->
      </div>
      <div id="right">
        <h1>Gracze</h1>

        <div id="players"></div>
      </div>
    </div>

    <!-- <script type="module" src="game.js">

    </script> -->
    <script type="module">
      import Game from "./game.js"

      //część srewerowa
      var ok = true
      var times = [];
      var timer;
      var data;
      var myID = "none"
      var room;
      var currentTime;
      var myName
      var functions
      getData();

      var getter = setInterval(getData, 1000);
      var timer = setInterval(displayTime, 50);
      var recorder = setInterval(displayRecords, 50);

      async function getData() {
        const body = JSON.stringify({ "id": myID }); // body czyli przesyłane na serwer dane
        const headers = { "Content-Type": "application/json" }; // nagłowek czyli typ danych

        await fetch("/getData", { method: "post" ,body, headers }) // fetch
          .then((response) => response.text())
          .then((d) => (data = JSON.parse(d)));
        console.log(data);
      }
      



      
      function fetchMyData(x) {
        const body = JSON.stringify({ name: x, startTime: currentTime }); // body czyli przesyłane na serwer dane

        const headers = { "Content-Type": "application/json" }; // nagłowek czyli typ danych
        // console.log(body)
        fetch("/addplayer", { method: "post", body, headers }) // fetch
          .then((response) => response.json())
          .then(
            (data) => (myID = data.yourID) // dane odpowiedzi z serwera
          );
      }

      function uploadScoore() {
        console.log("Finished");

        clearInterval(timer);
        let time = getPlayingTime();
        const body = JSON.stringify({ time: time, id: myID }); // body czyli przesyłane na serwer dane

        const headers = { "Content-Type": "application/json" }; // nagłowek czyli typ danych
        // console.log(body)
        fetch("/uploadScoore", { method: "post", body, headers }) // fetch
          .then((response) => response.json())
          .then(
            (data) => console.log(data) // dane odpowiedzi z serwera
          );

        //wyświetlenie wygranej
        let x = document.getElementById("winScreen");
        x.style.display = "inline";

        console.log(data.records);
        // console.log(data.records.)

        if (data.records.length == 10) {
          if (time < data.records[data.records.length - 1].time) {
            x.innerHTML = convertTime(time) + "<br> Nowy rekord";
          } else {
            x.innerHTML =
              convertTime(time) +
              "<br> Niestety, w pierwszej 10 to ty nie jesteś";
          }
        } else {
          x.innerHTML = convertTime(time) + "<br> Nowy rekord";
        }

        document.getElementsByClassName("box")[0].style.left ="-10px";
        document.getElementsByClassName("box")[0].classList.remove("extend1")
        document.getElementById("replay").style.top = "-10px";
        document.getElementById("replay").classList.remove("extend2")
        document.getElementById("open").classList.remove("extend3")

        // transform: translateY(210px);
      }

        function JaChceJeszczeRaz() {
          document.getElementsByClassName("box")[0].classList.add("extend1")
          document.getElementById("replay").classList.add("extend2")
        document.getElementById("open").classList.add("extend3")
            let x = document.getElementById("winScreen").style.display = "none"
            document.getElementsByClassName("box")[0].style.left ="-300px";
            document.getElementById("replay").style.top = "-220px";

            clearInterval(getter);
            clearInterval(timer);
            startClock();
            console.log("PPPPPPPP")
            // drop()
            getter = setInterval(getData, 1000);
            timer = setInterval(displayTime, 50);
            functions.randomizer();
            setTimeout(() => {      
              fetchMyData(myName)
            }
            ,1000)
            setTimeout(() => {      
              ok = true
            },4000)
        }

        document.getElementById("x").addEventListener("click", function () {


          document.getElementById("login").style.display = "none";
          console.log("XXX");
          myName = document.getElementById("name").value;

          myName = myName.replace(/\s+/g, '');
          if(myName.length == 0){
              alert('nick too short, ur name is anopnymous')
              startClock();
              myName = 'anonymous'
              fetchMyData(myName);
          }
          else if(myName.length > 13){
            alert('nick too long, ur nick is '+ myName.slice(0,13))
            startClock();
            myName = myName.slice(0,12)
            fetchMyData(myName);
          }
          else if(myName =="ds" || myName =="DS" || myName =="Ds" || myName =="dS"){
            startClock();
            myName = 'XD'
            fetchMyData(myName);
          }
          else{
            startClock();
            fetchMyData(myName);
          }
          document.getElementById("nick").innerHTML = myName

      });


      //CZAS

      function startClock() {
        currentTime = Date.now();
        console.log("AAA");
      }

      function getPlayingTime() {
        var time = Date.now() - currentTime;
        console.log(time);
        return time;
      }

      function convertTime(duration) {
        var milliseconds = parseInt((duration % 1000) / 100),
          seconds = Math.floor((duration / 1000) % 60),
          minutes = Math.floor((duration / (1000 * 60)) % 60),
          hours = Math.floor((duration / (1000 * 60 * 60)) % 24);

        hours = hours < 10 ? "0" + hours : hours;
        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;

        return hours + ":" + minutes + ":" + seconds + "." + milliseconds;
      }




    function displayTime() {
        //twój czas
        document.getElementById("timeBlock").innerHTML = convertTime(
            getPlayingTime()
        );
    }
    function displayRecords() {
        //rekordy w sidebarze
        var table = "<table><tr><td>NICK</td><td>CZAS</td></tr>";
        data.records.forEach((element) => {
            table +=
                "<tr><td>" +
                element.player +
                "</td><td>" +
                convertTime(element.time) +
                "</td></tr>";
        });
        table += "</table>";
        document.getElementById("records").innerHTML = table;
        // gracze w sidebarze
        table = "<table><tr><td>NICK</td><td>CZAS</td></tr>";
        data.players.forEach((element) => {
            if (element.status == "playing") {
                table +=
                    "<tr><td>" +
                    element.player +
                    "</td><td>" +
                    convertTime(Date.now() - element.startTime) +
                    "</td></tr>";
            } else {
                table +=
                    "<tr><td>" +
                    element.player +
                    "</td><td>" +
                    convertTime(element.startTime) +
                    "</td></tr>";
                // playerString += element.player + " Zakończono: " + convertTime(element.startTime) + "<br>"
            }
        });
        table += "</table>";
        document.getElementById("currentPlayers").innerHTML = table;

        //rekordy przy logowaniu
        
        var playerString = "";
        data.players.forEach((element) => {
            if (element.status == "playing") {
                playerString +=
                    element.player +
                    " " +
                    convertTime(Date.now() - element.startTime) +
                    "<br>";
            } else {
                playerString +=
                    element.player +
                    " Zakończono: " +
                    convertTime(element.startTime) +
                    "<br>";
            }
        });
        document.getElementById("players").innerHTML = playerString;
    }


























      

      $(document).ready(function () {

        functions = new Game()
        functions.sceneGenerator();
        functions.mapGenerator();
        functions.createIntelligentTable();
        functions.handleEventListeners();
        functions.randomizer();
        functions.selectingBlocks();
      });
    </script>
  </body>
</html>

</html>